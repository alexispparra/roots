
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default security: Deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // Rule for user profiles
    // A user can create their own profile.
    // A user can read and update their own profile.
    match /users/{userId} {
      allow create: if request.auth.uid != null;
      allow read, update: if request.auth.uid == userId;
    }
    
    // Rule for projects
    // A user can list projects (this is crucial and was missing).
    // A user can read or write to a project document if their email is in the `participantsEmails` array.
    match /projects/{projectId} {
       allow list: if request.auth != null;
       allow read, write: if request.auth.uid != null && request.auth.token.email in resource.data.participantsEmails;
    }
  }
}
