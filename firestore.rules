
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Projects Collection ---
    match /projects/{projectId} {
      // Any authenticated user can create a project. The owner is set in client code.
      allow create: if request.auth != null;

      // Only users listed in the 'participantsEmails' array can read or write to the project.
      allow read, write: if request.auth.token.email in resource.data.participantsEmails;
    }

    // --- Users Collection ---
    match /users/{userId} {
      // 1. Admin Rule: An admin can read and write ANY user document.
      // 'read' covers 'get' and 'list'. 'write' covers 'create', 'update', 'delete'.
      // This is the broad rule for the admin.
      allow read, write: if request.auth.token.email == 'alexispparra@gmail.com';

      // 2. User Rule: A non-admin user can get and update THEIR OWN document.
      // This rule is evaluated if the admin rule is false.
      allow get, update: if request.auth.uid == userId;

      // 3. Create Rule: Any authenticated user can create a user document,
      // but only if the UID of the new document matches their own auth UID.
      // This prevents users from creating profiles for others.
      allow create: if request.auth.uid == userId;
    }
  }
}
