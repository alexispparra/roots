rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // PROJECTS:
    // A user can query, read, or write projects where their email is in the participants list.
    // This rule correctly supports the query used in the application.
    match /projects/{projectId} {
      allow read, write: if request.auth.token.email in resource.data.participantsEmails;
    }

    // USERS:
    // This block defines all rules for the 'users' collection.
    match /users/{userId} {
      // --- Rules for accessing a SINGLE user document ---

      // A user can GET their own document.
      allow get: if request.auth.uid == userId;
      // An admin can GET any user's document.
      allow get: if request.auth.token.email == 'alexispparra@gmail.com';

      // A user can CREATE their own document (e.g., on sign-up).
      allow create: if request.auth.uid == userId;

      // A user can UPDATE their own document.
      allow update: if request.auth.uid == userId;
      // An admin can UPDATE any user's document.
      allow update: if request.auth.token.email == 'alexispparra@gmail.com';


      // --- Rule for accessing the ENTIRE user collection ---

      // An admin can LIST the entire collection.
      // NOTE: This rule's condition CANNOT use `userId`. It is evaluated
      // on the collection, and is placed here for organization.
      allow list: if request.auth.token.email == 'alexispparra@gmail.com';
    }
  }
}
