rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Projects Collection ---
    match /projects/{projectId} {
      function isParticipant() {
        return request.auth.token.email in resource.data.participantsEmails;
      }
      
      function isOwner() {
        return request.auth.token.email == request.resource.data.ownerEmail;
      }

      allow read, write: if isParticipant();
      allow create: if request.auth != null && isOwner() && isParticipant();
    }

    // --- Users Collection Rules ---

    // Rule for LISTING the entire collection.
    // This is the key fix: 'list' applies to the collection path, not the document path with a wildcard.
    match /users {
      allow list: if request.auth.token.email == 'alexispparra@gmail.com';
    }

    // Rules for individual user documents (GET, CREATE, UPDATE).
    match /users/{userId} {
      function isOwner() {
        return request.auth.uid == userId;
      }
      
      function isAdmin() {
        return request.auth.token.email == 'alexispparra@gmail.com';
      }

      // Allow creating own user document upon signup.
      allow create: if isOwner();
      
      // Allow getting and updating own document, or any document if admin.
      allow get, update: if isOwner() || isAdmin();
    }
  }
}
